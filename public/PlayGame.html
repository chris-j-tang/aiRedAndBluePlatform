<!DOCTYPE html>

<html lang="en">

<head>
	<title>Red & Blue Game - Play Game</title>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="style/style.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css">
	<script src="https://code.jquery.com/jquery-1.12.1.min.js" integrity="sha256-I1nTg78tSrZev3kjvfdM5A5Ak/blglGzlaZANLPDl3I=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>

</head>

<body>
	<div id="scoreBar">
		<div id="redScore">
			<p id="scoreBarText">Score</p>
			<p id="redScoreBarText">-</p>
		</div>

		<div id="blueScore">
			<p id="scoreBarText">Score</p>
			<p id="blueScoreBarText">-</p>
		</div>

		<div id="yourGameSession">
			<p id="timeTextValue">-</p>
			<i id="arrowLeft"></i>
			<p id="roundTextValue">- out -</p>
			<i id="arrowRight"></i>
		</div>
	</div>

	<div id="mynetwork"></div>

</body>

<script type="text/javascript">

var loc = sessionStorage.getItem('loc');
var act = sessionStorage.getItem('action');
var player = {
	"id" : sessionStorage.getItem("playerName")
};

console.log(loc);

var redScore = 0;
var blueScore = 0
var timeLimit = 0;
var rounds = 0;
var curRound = 1;
var curTime = 0;
var nodeCount = 0;
var turn = 1;

var nodes = null;
var hoverNodes = [];
var hoverEdges = [];

var updateTime;
var timer;

var visNodes;
var visEdges;
var data;
var network;

if(loc != undefined && act != undefined) {
	if(act == "spectate") {
		$.get("http://localhost:4040" + loc, function(data, status, xhr) {
			console.log(data);
			console.log(status);
			console.log(xhr);
			timeLimit = 100;
			curTime = 100;
			rounds = data.static.rounds;

			nodeCount = data.static.graph.length;
			setRedScore(redScore)
			setBlueScore(blueScore)
			setRound(data.curRound)
			setTurn(data.turn);

			makeGraph(data);

			observe();
		}, 'json');
	}
	else if(act == "join") {
		$.post("http://localhost:4040" + loc, player, function(data, status, xhr) {
			console.log(data);
			console.log(status);
			console.log(xhr);
			timeLimit = data.static.time;
			curTime = data.static.time;
			rounds = data.static.rounds;
			//turn = data.turn;
			nodeCount = data.static.graph.length;
			setRedScore(redScore)
			setBlueScore(blueScore)
			setRound(curRound)
			setTurn(turn);

			makeGraph(data);

			startGame();

			startTimer();
		}, 'json');
	}
}

var noHoverColor = {
	color:
	{
		border: '#111111',
		background: '#999999'
	}
};

var noColor = {
	color: {
		border: '#444444',
		background: '#CCCCCC',
		hover: {
			border: noHoverColor.color.border,
			background: noHoverColor.color.background
		}
	}
};

var redHoverColor = {
	color:
	{
		border: '#aa2020',
		background: '#bc2525'
	}
};

var redColor = {
	color:
	{
		border: '#dd2e2e',
		background: '#e83a3a',
		hover: {
			border: redHoverColor.color.border,
			background: redHoverColor.color.background
		}
	}
};

var blueHoverColor = {
	color:
	{
		border: '#2155a8',
		background: '#2f65bc'
	}
};

var blueColor = {
	color:
	{
		border: '#306ccc',
		background: '#4286f4',
		hover: {
			border: blueHoverColor.color.border,
			background: blueHoverColor.color.background
		}
	}
};

// create a network
var container = document.getElementById('mynetwork');

var options = {
	manipulation: false,
	interaction:
	{
		dragNodes: false,
		dragView: false,
		hover: true
	},
	layout:
	{
		randomSeed: 0
	},
	edges: {
		hoverWidth: 0.0,
		chosen:  {
			edge: function(values, id, selected, hovering) {
					values.width = 3;
				  }
		},
		color: {
			inherit: false
		},
		smooth: {
			type: "discrete",
			forceDirection: "none",
			roundness: 0
		}
	},
	nodes: {
		color: noColor.color
	}
};

function startGame() {
	requestMove();
}

var observeTimer;
function observe() {
	clearTimeout(observeTimer);
	observeTimer = setTimeout(function() {
		$.get("http://localhost:4040" + loc, function(data, status, xhr) {
			//console.log(data);
			//console.log(status);
			//console.log(xhr);

			var diff = makeDiff(data);
			updateGraph(diff);

			curTime = data.static.time - (new Date().getTime() - data.lastUpdate);
			turn = data.turn % 2 + 1;

			setTime(curTime);
			setTurn(turn);

			if(!data.isDone) {
				observe();
			}
		}, 'json');
	}, timeLimit);
}

function requestMove() {
	startTimer();
	$.get("http://localhost:4040" + loc + "/" + player.id, function(data, status, xhr) {
		console.log(data);
		console.log(status);
		console.log(xhr);

		//Update Graph
		if(data.delta != undefined) {
			updateGraph(data);
			turn = turn == 1 ? 2 : 1;
		}
		setTurn(turn);
		startTimer();
	}, 'json');
}

function submitMove(nodeId) {
	var node = {
		"node" : nodeId
	};
	$.post("http://localhost:4040" + loc + "/" + player.id, node, function(data, status, xhr) {
		console.log(data);
		console.log(status);
		console.log(xhr);

		//Update Graph
		updateGraph(data);
		turn = turn == 1 ? 2 : 1;
		setTurn(turn);
		requestMove();
	}, 'json');
}

function startTimer() {
	clearInterval(updateTime);
	clearTimeout(timer);
	curTime = timeLimit;
	updateTime = setInterval(function() {
		setTime(curTime);
		curTime -= 100;
	},100);

	timer = setTimeout(function() {
		clearInterval(updateTime);
		setTime(curTime);
	}, timeLimit);
}

function setRedScore(score) {
	document.getElementById("redScoreBarText").innerHTML = score;
}

function setBlueScore(score) {
	document.getElementById("blueScoreBarText").innerHTML = score;
}

function setTime(time) {
	var timeStr = Math.round(time / 1000).toString();
	timeStr += "." + (Math.round((time / 100)) % 10).toString();
	document.getElementById("timeTextValue").innerHTML = timeStr;
}

function setRound(round) {
	document.getElementById("roundTextValue").innerHTML = round + " out of " + rounds;
}

function setTurn(turn) {
	var redTurn = document.getElementById("arrowLeft");
	var blueTurn = document.getElementById("arrowRight");
	if(turn == 1) {
		blueTurn.style.visibility = 'hidden';
		redTurn.style.visibility = 'visible';
	}
	else if(turn == 2) {
		blueTurn.style.visibility = 'visible';
		redTurn.style.visibility = 'hidden';
	}
	else {
		redTurn.style.visibility = 'hidden';
		blueTurn.style.visibility = 'hidden';
	}
}

var Node = function(id) {
	this.id =  id;
	this.label = id.toString();
	this.borderWidth = 2;
	this.borderWidthSelected = 3;
	this.color = noColor;
	this.font = {
		size: 16
	};
	this.team = 0;
}

function makeGraph(state) {
	console.log("Make Graph");
	nodes = createNodes(state);
	visNodes = new vis.DataSet(nodes);
	visEdges = new vis.DataSet(createEdges(state.static.graph));
	data = {
		nodes: visNodes,
		edges: visEdges
	};
	network = new vis.Network(container, data, options);
	if(act == 'join') {
		network.on("click", function (params) {
			var selectedNodeId = params.nodes[0];
			submitMove(selectedNodeId);
			network.unselectAll();
		});
	}
	network.on("hoverNode", function (params) {
		var nodeId = params.node;

		network.body.nodes[nodeId].setOptions(nodes[nodeId].team == 0 ? noHoverColor : nodes[nodeId].team == 1 ? redHoverColor : blueHoverColor);
		hoverNodes.push(nodeId);

		var selectedEdges = network.getConnectedEdges(nodeId);

		for(var i = 0; i < selectedEdges.length; i++) {
			var edgeId = selectedEdges[i];
			var adjId = network.body.edges[edgeId].to.id != nodeId ? network.body.edges[edgeId].to.id : network.body.edges[edgeId].from.id;
			var n = network.body.nodes[adjId];

			n.setOptions(nodes[adjId].team == 0 ? noHoverColor : nodes[adjId].team == 1 ? redHoverColor : blueHoverColor);

			hoverNodes.push(adjId);
			hoverEdges.push(edgeId);
		}
	});
	network.on("blurNode", function (params) {
		for(var i = 0; i < hoverNodes.length; i++) {
			var nodeId = hoverNodes[i];
			var n = network.body.nodes[nodeId];
			n.setOptions(nodes[nodeId].team == 0 ? noColor : nodes[nodeId].team == 1 ? redColor : blueColor);
		}
		hoverNodes.length = 0;
		hoverEdges.length = 0;
	});

	/*
	network.on("hoverEdge", function (params) {
		var x = event.clientX - $('#mynetwork').offset().left;
		var y = event.clientY - $('#mynetwork').offset().top;
		console.log(x.toString() + ", " + y.toString());
		console.log(network.getSelectedEdges());
	});*/
}

function createNodes(state) {
	var nodeList = [];
	for(var i = 0; i < state.static.graph.length; i++) {
		var n = new Node(i);
		n.color = state.colors[i] == 0 ? noColor.color : state.colors[i] == 1 ? redColor.color : blueColor.color;
		nodeList.push(n);
	}
	return nodeList;
}

function createEdges(graph) {
	var edgeList = [];
	for(var i = 0; i < graph.length; i++) {
		var n = graph[i];
		for(var k = 0; k < n.length; k++) {
			var e = {from: i, to: n[k]};
			edgeList.push(e);
		}
	}
	return edgeList;
}

function updateGraph(diff) {
	curRound = diff.round + 1;
	redScore = diff.scores[0];
	blueScore = diff.scores[1];

	if(diff.delta != undefined) {
		for(var i = 0; i < diff.delta.length; i++) {
			var nodeId = diff.delta[i];
			var n = network.body.nodes[nodeId];
			n.setOptions(turn == 1 ? redColor : blueColor);
			nodes[nodeId].team = turn;
		}
		if(diff.delta.length > 0) {
			network.redraw();
		}
	}

	setRedScore(redScore);
	setBlueScore(blueScore);
	setRound(curRound);
}

function makeDiff(state) {
	var diff = {
		round: state.curRound,
		scores: state.scores,
		delta: []
	};

	for(var i = 0; i < state.colors.length; i++) {
		var c = state.colors[i];
		if(nodes[i].team != c) {
			diff.delta.push(i);
		}
	}
	return diff;
}

</script>

<script type="text/javascript">
	window.onload = function() {
		var data = {
			playerName: sessionStorage.getItem("playerName"),
			sessionID: sessionStorage.getItem("sessionID"),
			host: sessionStorage.getItem("host"),
			socketID: "null"
		};
	};
</script>
</html>
